#include p18f458.inc
D1uL	EQU D'2'			
DR1uL	EQU 0x0D		
DAY 	EQU 10H			
MON 	EQU 11H			
DAT	EQU 12H			
YR	EQU 13H			
HR	EQU 14H			
MIN	EQU 15H			
SEC	EQU 16H			
CNT 	EQU 20H			
TMP 	EQU 21H			
	MOVLW 0x00
	MOVWF SSPSTAT 
	MOVLW 0x22
	MOVWF SSPCON1 		
	CLRF TRISC	  		
	BSF TRISC,SDI 		
	BSF TRISC,RX  		
   	MOVLW B'00100000' 	
   	MOVWF TXSTA          
   	MOVLW D'15'      
   	MOVWF SPBRG          
   	BCF TRISC, TX    
   	BSF RCSTA, SPEN      	
	MOVLW 0x0A			
	CALL TRANS
	MOVLW 0x0D			
	CALL TRANS
	BSF	PORTC,RC2 		
	CALL SDELAY
	MOVLW 0x8F   		
	CALL SPI
	MOVLW 0x00   		
	CALL SPI
	BCF PORTC,RC2		
	CALL SDELAY
	BSF	PORTC,RC2 		
	MOVLW 0x80   	
	CALL SPI 			
	MOVLW 0x55   		
	CALL SPI 			
	MOVLW 0x58   		
	CALL SPI 			
	MOVLW 0x16   		
	CALL SPI 			
	MOVLW 0x3   		
	CALL SPI 			
	MOVLW 0x19   		
	CALL SPI 			
	MOVLW 0x10   		
	CALL SPI 			
	MOVLW 0x04   		
	CALL SPI 			
	BCF PORTC,RC2		
	CALL SDELAY
RDA	BSF	PORTC,RC2 		
	CALL SDELAY
	MOVLW 0x00		
	CALL SPI 			
	CALL SPI 			
	MOVWF SEC	 		
	CALL SPI 			
	MOVWF MIN 	 		
	CALL SPI 			
	MOVWF HR	 		
	CALL SPI 			
	MOVWF DAY	 		
	CALL SPI 			
	MOVWF DAT	 		
	CALL SPI 			
	MOVWF MON	 		
	CALL SPI 			
	MOVWF YR	 		
	BCF PORTC,RC2		
	LFSR FSR0,0x11	
	MOVLW D'6'			
	MOVWF CNT			
SND	MOVFF INDF0,TMP		
	MOVLW 0xF0			
	ANDWF TMP,F		
	SWAPF TMP,F		
	MOVLW 0x30			
	IORWF TMP,W		
	CALL TRANS			
	MOVFF  POSTINC0,TMP	
	MOVLW 0x0F			
	ANDWF TMP,F		
	MOVLW 0x30			
	IORWF TMP,W		
	CALL TRANS			
	MOVLW ':'
	CALL TRANS	
	DECFSZ CNT			
	BRA SND			
	MOVLW 0x0D			
	CALL TRANS
	BRA RDA	
SPI	MOVWF SSPBUF		
WAIT	BTFSS SSPSTAT,BF		
	BRA WAIT
	MOVF SSPBUF,W		
	RETURN			
TRANS	BTFSS PIR1, TXIF	    
    	BRA TRANS       	
    	MOVWF TXREG    	
	RETURN			
SDELAY: MOVLW	D1uL		
	MOVWF	DR1uL			
DS1 	DECF DR1uL,F		
     BNZ	DS1
    	RETURN
	END
